syntax = "proto3";

package stats.v1;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "common/v1/enums.proto";
import "common/v1/types.proto";
import "validate/validate.proto";

option go_package = "github.com/bonaysoft/vocnet/api/gen/stats/v1;statsv1";

// Statistics and analytics service for learning progress
service StatsService {
  // Get comprehensive learning statistics for dashboard
  rpc GetLearningStats(GetLearningStatsRequest) returns (GetLearningStatsResponse) {
    option (google.api.http) = {
      get: "/api/v1/users/{user_id}/stats"
    };
  }
  
  // Get mastery level distribution
  rpc GetMasteryDistribution(GetMasteryDistributionRequest) returns (GetMasteryDistributionResponse) {
    option (google.api.http) = {
      get: "/api/v1/users/{user_id}/stats/mastery-distribution"
    };
  }
  
  // Get learning progress over time
  rpc GetLearningProgress(GetLearningProgressRequest) returns (GetLearningProgressResponse) {
    option (google.api.http) = {
      get: "/api/v1/users/{user_id}/stats/progress"
    };
  }
  
  // Get review statistics
  rpc GetReviewStats(GetReviewStatsRequest) returns (GetReviewStatsResponse) {
    option (google.api.http) = {
      get: "/api/v1/users/{user_id}/stats/reviews"
    };
  }
  
  // Get top difficult words (frequently failed)
  rpc GetDifficultWords(GetDifficultWordsRequest) returns (GetDifficultWordsResponse) {
    option (google.api.http) = {
      get: "/api/v1/users/{user_id}/stats/difficult-words"
    };
  }
}

// GetLearningStats request
message GetLearningStatsRequest {
  int64 user_id = 1 [(validate.rules).int64.gt = 0];
}

message GetLearningStatsResponse {
  LearningOverview overview = 1;
  repeated common.v1.MasteryLevelCount mastery_distribution = 2;
  RecentActivity recent_activity = 3;
}

// GetMasteryDistribution request
message GetMasteryDistributionRequest {
  int64 user_id = 1 [(validate.rules).int64.gt = 0];
  common.v1.Language language = 2;                        // Optional filter by language
}

message GetMasteryDistributionResponse {
  repeated common.v1.MasteryLevelCount distribution = 1;
  int32 total_words = 2;
}

// GetLearningProgress request
message GetLearningProgressRequest {
  int64 user_id = 1 [(validate.rules).int64.gt = 0];
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
  ProgressGranularity granularity = 4;                    // daily, weekly, monthly
}

message GetLearningProgressResponse {
  repeated ProgressDataPoint data_points = 1;
  ProgressSummary summary = 2;
}

// GetReviewStats request
message GetReviewStatsRequest {
  int64 user_id = 1 [(validate.rules).int64.gt = 0];
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
}

message GetReviewStatsResponse {
  ReviewSummary summary = 1;
  repeated ReviewDataPoint daily_reviews = 2;
}

// GetDifficultWords request
message GetDifficultWordsRequest {
  int64 user_id = 1 [(validate.rules).int64.gt = 0];
  int32 limit = 2 [(validate.rules).int32 = {gte: 1, lte: 50}];  // Default 10
}

message GetDifficultWordsResponse {
  repeated DifficultWordInfo words = 1;
}

// Supporting message types

message LearningOverview {
  int32 total_words = 1;
  int32 mastered_words = 2;
  int32 learning_words = 3;
  int32 words_due_for_review = 4;
  int32 new_words_this_week = 5;
  int32 reviews_completed_today = 6;
  int32 current_streak_days = 7;
  int32 longest_streak_days = 8;
  google.protobuf.Timestamp last_activity_at = 9;
}

message RecentActivity {
  repeated ActivityEvent recent_events = 1;
  ActivitySummary daily_summary = 2;
  ActivitySummary weekly_summary = 3;
}

message ActivityEvent {
  string event_type = 1;                                  // "word_added", "mastery_updated", "review_completed"
  string description = 2;                                 // Human readable description
  google.protobuf.Timestamp timestamp = 3;
}

message ActivitySummary {
  int32 words_added = 1;
  int32 words_reviewed = 2;
  int32 mastery_improvements = 3;
  int32 sentences_added = 4;
}

message ProgressDataPoint {
  google.protobuf.Timestamp date = 1;
  int32 total_words = 2;
  int32 mastered_words = 3;
  int32 words_added = 4;
  int32 reviews_completed = 5;
  float average_mastery_score = 6;
}

message ProgressSummary {
  int32 total_words_added = 1;
  int32 total_reviews_completed = 2;
  float mastery_improvement = 3;                          // Average mastery score improvement
  int32 most_productive_day_words = 4;
  google.protobuf.Timestamp most_productive_date = 5;
}

message ReviewSummary {
  int32 total_reviews = 1;
  int32 successful_reviews = 2;
  int32 failed_reviews = 3;
  float success_rate = 4;
  int32 average_reviews_per_day = 5;
}

message ReviewDataPoint {
  google.protobuf.Timestamp date = 1;
  int32 reviews_completed = 2;
  int32 successful_reviews = 3;
  int32 failed_reviews = 4;
  float success_rate = 5;
}

message DifficultWordInfo {
  int64 user_word_id = 1;
  string word_text = 2;
  common.v1.MasteryLevel current_mastery = 3;
  int32 total_reviews = 4;
  int32 failed_reviews = 5;
  float failure_rate = 6;
  google.protobuf.Timestamp last_failed_at = 7;
  repeated string common_mistakes = 8;                    // Common error patterns
}

// Enums
enum ProgressGranularity {
  PROGRESS_GRANULARITY_UNSPECIFIED = 0;
  PROGRESS_GRANULARITY_DAILY = 1;
  PROGRESS_GRANULARITY_WEEKLY = 2;
  PROGRESS_GRANULARITY_MONTHLY = 3;
}